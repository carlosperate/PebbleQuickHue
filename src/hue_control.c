#include "main.h"
#include "hue_control.h"


/*******************************************************************************
* Types
*******************************************************************************/
enum {
    KEY_LIGHT_STATE = 0,
    KEY_BRIGHTNESS = 1,
};


/*******************************************************************************
* AppMessage functions
*******************************************************************************/
void inbox_received_callback(DictionaryIterator *iterator, void *context) {
    // Read first item
    Tuple *t = dict_read_first(iterator);
    
    // For all items
    while(t != NULL) {
        switch(t->key) {
            case KEY_LIGHT_STATE:
                // Indicate to the GUI that the light is ON/OFF
                gui_light_state((bool)t->value->uint8);
                break;
            default:
                APP_LOG(APP_LOG_LEVEL_ERROR, "Key %d not recognized!", (int)t->key);
            break;
        }
        t = dict_read_next(iterator);
    }
}


void inbox_dropped_callback(AppMessageResult reason, void *context) {
    APP_LOG(APP_LOG_LEVEL_ERROR, "Message dropped!");
}


void outbox_failed_callback(
        DictionaryIterator *iterator, AppMessageResult reason, void *context) {
    APP_LOG(APP_LOG_LEVEL_ERROR, "Outbox send failed!");
}


void outbox_sent_callback(DictionaryIterator *iterator, void *context) {
    APP_LOG(APP_LOG_LEVEL_INFO, "Outbox send success!");
}


/*******************************************************************************
* Hue control functions
*******************************************************************************/
void toggle_light_state() {
    // Prepare dictionary
    DictionaryIterator *iterator;
    app_message_outbox_begin(&iterator);

    // Add a key-value pair
    int key = KEY_LIGHT_STATE;
    char value = 0;  // Value ignored, going to toggle
    dict_write_int(iterator, key, &value, sizeof(char), true /* signed */);

    // Send the message!
    app_message_outbox_send();
}


void set_brightness(char level) {
    // Prepare dictionary
    DictionaryIterator *iterator;
    app_message_outbox_begin(&iterator);

    // Add a key-value pair
    int key = KEY_BRIGHTNESS;
    dict_write_int(iterator, key, &level, sizeof(char), true /* signed */);

    // Send the message!
    app_message_outbox_send();
}
